<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <svg></svg>
    <script src="./d3.v5.min.js"></script>
    <script>
      const urls = ["http://localhost:5000/get_health_care_graph_small"];
      computeLayoutWithLatLon(urls[0]);
      function computeLayoutWithLatLon(url) {
        const width = 800,
          height = 800,
          padding = 0.1;

        var simulation = d3.forceSimulation();
        simulation
          .force(
            "link",
            d3.forceLink().id(function (d) {
              return d.id;
            })
          )
          .force("charge", d3.forceManyBody().distanceMax(5))
          .force("center", d3.forceCenter(width / 2, height / 2));

        fetch(url)
          .then((res) => {
            return res.json();
          })
          .then((data) => {
            layout(data["2019/12"]);
          });

        function layout(graph) {
          const max = {
            LAT: -Infinity,
            LNG: -Infinity,
          };
          const min = {
            LAT: Infinity,
            LNG: Infinity,
          };
          graph.nodes.forEach((node) => {
            if ("type" in node) {
              // it is a hospital
              if (!("LAT" in node)) {
                node["LAT"] = 120 + (Math.random() - 1 / 2) / 10;
              }
              if (!("LNG" in node)) {
                node["LNG"] = 30 + (Math.random() - 1 / 2) / 10;
              }
              min["LAT"] = Math.min(min["LAT"], node["LAT"]);
              min["LNG"] = Math.min(min["LNG"], node["LNG"]);
              max["LAT"] = Math.max(max["LAT"], node["LAT"]);
              max["LNG"] = Math.max(max["LNG"], node["LNG"]);
            }
          });
          const scale = {
            LAT: d3
              .scaleLinear()
              .domain([min["LAT"], max["LAT"]])
              .range([width * padding, width * (1 - padding)]),
            LNG: d3
              .scaleLinear()
              .domain([min["LNG"], max["LNG"]])
              .range([height * padding, height * (1 - padding)]),
          };
          graph.nodes.forEach((node) => {
            if ("type" in node) {
              // it is a hospital
              node["LAT"] = scale["LAT"](node["LAT"]);
              node["LNG"] = scale["LNG"](node["LNG"]);
            }
          });

          var svg = d3.select("svg");
          svg.attr("width", width);
          svg.attr("height", height);
          svg.html("");
          var link = svg
            .append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graph.links)
            .enter()
            .append("line")
            .attr("stroke", "black")
            .attr("stroke-width", 1);

          var node = svg
            .append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(graph.nodes)
            .enter()
            .append("g");

          var circles = node.append("circle").attr("r", 1.5);

          simulation.nodes(graph.nodes).on("tick", ticked);

          simulation.force("link").links(graph.links);

          function ticked() {
            graph.nodes.forEach((node) => {
              if ("LAT" in node && "LNG" in node) {
                node.x = node["LAT"];
                node.y = node["LNG"];
              }
            });
            link
              .attr("x1", function (d) {
                return d.source.x;
              })
              .attr("y1", function (d) {
                return d.source.y;
              })
              .attr("x2", function (d) {
                return d.target.x;
              })
              .attr("y2", function (d) {
                return d.target.y;
              });

            node.attr("transform", function (d) {
              return "translate(" + d.x + "," + d.y + ")";
            });
          }
        }
      }
    </script>
  </body>
</html>
